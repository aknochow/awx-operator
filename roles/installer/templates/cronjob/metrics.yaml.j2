---
apiVersion: v1
kind: CronJob
metadata:
  name: {{ ansible_operator_meta.name }}-metrics
  namespace: '{{ ansible_operator_meta.namespace }}'
  labels:
    app.kubernetes.io/name: '{{ ansible_operator_meta.name }}-metrics'
    {{ lookup("template", "../common/templates/labels/common.yaml.j2") | indent(width=4) | trim }}
spec:
  schedule: "{{ _metrics_cronjob_schedule }}"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: {{ ansible_operator_meta.name }}-metrics
            image: "{{ _metrics_image }}"
            imagePullPolicy: "{{ image_pull_policy }}"
            command:
              - /bin/sh
              - -c
              - metrics-utility gather_automation_controller_billing_data --ship --until=10m
            envFrom:
            - configMapRef:
                name: {{ _metrics_configmap }}
            volumeMounts:
            - name: {{ ansible_operator_meta.name }}-metrics
              mountPath: /metrics
              readOnly: false
          volumes:
            - name: {{ ansible_operator_meta.name }}-metrics
              persistentVolumeClaim:
                claimName: {{ _metrics_pvc_claim }}
                readOnly: false
          restartPolicy: OnFailure